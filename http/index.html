<!DOCTYPE html>
<html>
    <head>
        <title>P2000 messages</title>

        <script>
            var ws = undefined;
            var messages = [];

            function onPageLoaded(){
                getMessagesAsync();
                initWebsocketListener();
            }

            function getMessagesAsync() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', "/api/messages", true);
                xhr.responseType = 'json';
                xhr.onload = function() {
                    var status = xhr.status;
                    if (status === 200) {
                        console.log("RES", xhr.response, typeof xhr.response);

                        messages = xhr.response;

                        document.getElementById('labelMessagesCount').innerHTML = xhr.response.length.toString()
                        buildHtmlTable(xhr.response)
                    } else {
                    }
                };
                xhr.send();
            }

            function initWebsocketListener() {
                var addr = "ws://" + window.location.hostname + ":8001/"
                console.log("Websocket connect:", addr);

                ws = new WebSocket(addr)
                ws.onmessage = function (event) {
                    console.log("WebSocket Message:", event.data);

                    var data = JSON.parse(event.data);
                    var found = false;
                    // If message was already added, ignore it (check last 10 messages)
                    for(var i=0; i<messages.length && i<10; i++) {
                        if (data['timestamp'] == messages[i]['timestamp'] && data['body'] ==  messages[i]['body'])
                            found = true;
                            break;
                    }
                    if (found == false) {
                        var count = addElement(data, 0);
                        document.getElementById('labelMessagesCount').innerHTML = count.toString();

                        messages.unshift(data);
                        if (messages.length > 100) {
                            messages = messages.slice(0, 100);
                        }
                    }
                }
            }

            function sendRequest(method) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', method, true);
                xhr.responseType = 'json';
                xhr.send();
            }

            function addElement(elem, index) {
                var table = document.getElementById("dataTable")

                var body_color = "#000000";
                if (elem['priority'] == 1) {
                    body_color = "#00AA00";
                }
                if (elem['priority'] == 2) {
                    body_color = "#0000AA";
                }
                if (elem['priority'] == 3 || elem['priority'] == 4) {
                    body_color = "#AA0000";
                }
                var html_body = '<font color="' + body_color + '">' + elem['body'] + '</font>';

                var row = table.insertRow(index);
                // Cell body
                var cellGr = row.insertCell();
                cellGr.style.color = "#000000";
                cellGr.innerHTML = elem['timestamp'] + "<br/>" + elem['groupid'] + ". " + "To: " + elem['receivers'] + "<br/>" + html_body;

                return table.rows.length;
            }

            function buildHtmlTable(myList) {
                var table = document.getElementById("dataTable")
                for(var i = 0; i < myList.length; i++ ) {
                    var elem = myList[i];

                    addElement(elem, i);
                }
            }

            function rebootDevice() {
                sendRequest("/api/reboot")
            }

            function poweroffDevice() {
                sendRequest("/api/poweroff")
            }
        </script>
    </head>


    <body bgcolor=white onload="onPageLoaded()">
        <p>P2000 FLEX messages receiver</p>
        <p>Messages loaded: <label id="labelMessagesCount">-</label></p>
        <p><a href="javascript:window.location.reload(false);">Reload</a> <a href="#BTM">To page bottom</a></p>
        <table border="0" cellpadding="10" id="dataTable">
        </table>
        <p id="BTM"><a href="javascript:rebootDevice();">Reset device</a> <a href="javascript:poweroffDevice();">Switch off device</a></p>
    </body>
</html>

