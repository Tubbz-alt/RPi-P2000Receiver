<!DOCTYPE html>
<html>
    <head>
        <title>P2000 messages</title>
        
        <link rel="stylesheet" href="/pure-css/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
        <link rel="stylesheet" href="/icons/css/all.css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

        <meta name="viewport" content="width=device-width, initial-scale=1">

        <style>
            input[type=checkbox] {
                vertical-align: middle;
                position: relative;
                bottom: 1px;
            }
        
            .content {
                max-width: 700px;
                margin: auto;
            }
        </style>

        <script>
            var ws = undefined;
            var messages = [];
            var filter = "";
            var show_pr0 = true, show_pr1 = true, show_pr2 = true, show_pr3 = true, show_pr4 = true;

            function onPageLoaded() {
                getMessagesAsync();
                initWebsocketListener();
            }

            function onCheckBox0Click() {
                show_pr0 = document.getElementById('check-prio0').checked;
                clearHtmlTable();
                buildHtmlTable(messages);
            }

            function onCheckBox1Click() {
                show_pr1 = document.getElementById('check-prio1').checked;
                clearHtmlTable();
                buildHtmlTable(messages);
            }

            function onCheckBox2Click() {
                show_pr2 = document.getElementById('check-prio2').checked;
                clearHtmlTable();
                buildHtmlTable(messages);
            }

            function onCheckBox3Click() {
                show_pr3 = document.getElementById('check-prio3').checked;
                show_pr4 = show_pr3;
                clearHtmlTable();
                buildHtmlTable(messages);
            }
        
            function onFilterApply() {
                var btn = document.getElementById('filter-txt');
                console.log("Filter:", btn.value);
                filter = btn.value;
                clearHtmlTable();
                buildHtmlTable(messages);
            }

            function onFilterClean() {
                filter = "";
                clearHtmlTable();
                buildHtmlTable(messages);
            }

            function getMessagesAsync() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', "/api/messages", true);
                xhr.responseType = 'json';
                xhr.onload = function() {
                    var status = xhr.status;
                    if (status === 200) {
                        console.log("RES", xhr.response, typeof xhr.response);

                        messages = xhr.response;
                        buildHtmlTable(messages)
                    } else {
                    }
                };
                xhr.send();
            }

            function initWebsocketListener() {
                var addr = "ws://" + window.location.hostname + ":8001/"
                console.log("Websocket connect:", addr);

                ws = new WebSocket(addr)
                ws.onmessage = function (event) {
                    console.log("WebSocket Message:", event.data);

                    var data = JSON.parse(event.data);
                    var found = false;
                    // If message was already added, ignore it (check last 10 messages)
                    for(var i=0; i<messages.length && i<10; i++) {
                        if (data['timestamp'] == messages[i]['timestamp'] && data['body'] ==  messages[i]['body'])
                            found = true;
                            break;
                    }
                    if (found == false) {
                        messages.unshift(data);
                        if (messages.length > 5000) {
                            messages = messages.slice(0, 5000);
                        }

                        var count = addElement(data, 0);
                        document.getElementById('labelMessagesDisplayed').innerHTML = count.toString();
                        document.getElementById('labelMessagesCount').innerHTML = messages.length.toString();
                    }
                }
            }

            function sendRequest(method) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', method, true);
                xhr.responseType = 'json';
                xhr.send();
            }
        
            function iconForSender(sender) {
                if (sender == 1)
                    return "<i class=\"fas fa-fire-extinguisher\"></i>";
                if (sender == 2)
                    return "<i class=\"fas fa-taxi\"></i>";
                if (sender == 3)
                    return "<i class=\"fas fa-ambulance\"></i>";
                return "<i class=\"fas fa-question\"></i>";
            }

            function addElement(elem, index) {
                var table = document.getElementById("dataTable")

                // Priority filter
                if (elem['priority'] == 0 && show_pr0 == false) {
                    return table.rows.length;
                }
                if (elem['priority'] == 1 && show_pr1 == false) {
                    return table.rows.length;
                }
                if (elem['priority'] == 2 && show_pr2 == false) {
                    return table.rows.length;
                }
                if (elem['priority'] == 3 && show_pr3 == false) {
                    return table.rows.length;
                }
                if (elem['priority'] == 4 && show_pr4 == false) {
                    return table.rows.length;
                }
                // Text filter
                if (filter.length > 0 && elem['body'].toLowerCase().includes(filter.toLowerCase()) == false && elem['receivers'].toLowerCase().includes(filter.toLowerCase()) == false) {
                    return table.rows.length;
                }

                // Add element
                var body_color = "#000000";
                if (elem['priority'] == 1) {
                    body_color = "#00AA00";
                }
                if (elem['priority'] == 2) {
                    body_color = "#0000AA";
                }
                if (elem['priority'] == 3 || elem['priority'] == 4) {
                    body_color = "#AA0000";
                }
                var html_body = '<font color="' + body_color + '">' + elem['body'] + '</font>';

                var row = table.insertRow(index);
                if (table.rows.length % 2 == 0)
                    row.className = "pure-table-odd";
                // Cell body
                var cellGr = row.insertCell();
                cellGr.style.color = "#000000";
                cellGr.innerHTML = iconForSender(elem['sender']) + " " + elem['timestamp'] + "<br/>" + elem['groupid'] + ". " + "To: " + elem['receivers'] + "<br/>" + html_body;

                return table.rows.length;
            }

            function buildHtmlTable(myList) {
                var table = document.getElementById("dataTable")
                for(var i = 0; i < myList.length; i++ ) {
                    var elem = myList[i];

                    addElement(elem, -1);
                }
                document.getElementById('labelMessagesDisplayed').innerHTML = table.rows.length.toString();
                document.getElementById('labelMessagesCount').innerHTML = myList.length.toString();
            }

            function clearHtmlTable() {
                var table = document.getElementById("dataTable")
                while(table.rows.length > 0) {
                    table.deleteRow(0);
                }
            }

            function reloadHtmlTable() {
                document.getElementById('labelMessagesCount').innerHTML = "loading..."
                getMessagesAsync()
            }

            function rebootDevice() {
                sendRequest("/api/reboot")
            }

            function poweroffDevice() {
                sendRequest("/api/poweroff")
            }
        </script>
    </head>


    <body bgcolor=white onload="onPageLoaded()">
        <div class="content">
        <p>P2000 FLEX messages receiver</p>
        <p><a href="javascript:window.location.reload(false);">Reload</a> <a href="#BTM">To page bottom</a></p>
        <p>Messages loaded: <label id="labelMessagesCount">-</label>, displayed: <label id="labelMessagesDisplayed">-</label></p>

        <form class="pure-form">
            <p>Priority filter:<br/><br/>
            <label>Priority-0: <input type="checkbox" id="check-prio0" checked onclick="onCheckBox0Click();" /></label>&nbsp;&nbsp;
            <label style="color: #00AA00">Priority-1: <input type="checkbox" id="check-prio1" checked onclick="onCheckBox1Click();" /></label>&nbsp;&nbsp;
            <label style="color: #0000AA">Priority-2: <input type="checkbox" id="check-prio2" checked onclick="onCheckBox2Click();" /></label>&nbsp;&nbsp;
            <label style="color: #AA0000">Priority-3: <input type="checkbox" id="check-prio3" checked onclick="onCheckBox3Click();" /></label></p>
            
            <p>Text filter:<br/>
            <input type="text" id="filter-txt" name="filter"/> <a onclick="onFilterApply()" class="pure-button" href="#">Apply</a> <a onclick="onFilterClean()" class="pure-button" href="#">Reset</a></p>
        </form>

        <table border="0" cellpadding="10" id="dataTable" class="pure-table" width="95%">
        </table>
        <p id="BTM"><a href="javascript:rebootDevice();">Reset device</a> <a href="javascript:poweroffDevice();">Switch off device</a></p>
        </div>
    </body>
</html>

